{% extends 'base.html' %}
{% block content %}
<h3>Send notification â€” {{ site.name }}</h3>

<form id="sendForm" method="post">
  <div class="mb-3">
    <label>Title</label>
    <input name="title" class="form-control" required>
  </div>

  <div class="mb-3">
    <label>Body / Description</label>
    <textarea name="body" class="form-control" rows="3"></textarea>
  </div>

  <div class="mb-3">
    <label>URL (open on click)</label>
    <input name="url" class="form-control" placeholder="https://example.com/path">
  </div>

  <div class="mb-3">
    <label>Target group</label>
    <select name="target_group" class="form-select">
      {% for g in groups %}
      <option value="{{ g }}">{{ g|capitalize }}</option>
      {% endfor %}
    </select>
    <small class="form-text text-muted">Send to specific device groups (desktop, android, ios, safari, phone) or All.</small>
  </div>

  <hr>

  <div class="mb-3">
    <label>Icon (small)</label>
    <div class="input-group">
      <input id="iconUrl" name="icon" class="form-control" placeholder="Paste uploaded icon URL or upload below">
      <button type="button" class="btn btn-outline-secondary" id="uploadIconBtn">Upload</button>
    </div>
    <small class="form-text text-muted">Recommended: 72x72 PNG/SVG</small>
  </div>

  <div class="mb-3">
    <label>Large Image (big image shown in notification)</label>
    <div class="input-group">
      <input id="imageUrl" name="image" class="form-control" placeholder="Paste uploaded image URL or upload below">
      <button type="button" class="btn btn-outline-secondary" id="uploadImageBtn">Upload</button>
    </div>
    <small class="form-text text-muted">Recommended: 1024x512 (or similar). Optional.</small>
  </div>

  <div class="mb-3">
    <button class="btn btn-primary">Send Notification</button>
  </div>
</form>

<!-- Hidden file inputs -->
<input id="fileInput" type="file" style="display:none" accept="image/*">

<script>
const uploadUrl = "{{ url_for('upload_file', site_id=site.id) }}";
document.getElementById('uploadIconBtn').addEventListener('click', () => chooseAndUpload('icon'));
document.getElementById('uploadImageBtn').addEventListener('click', () => chooseAndUpload('image'));

function chooseAndUpload(kind) {
  const fi = document.getElementById('fileInput');
  fi.onchange = async () => {
    const file = fi.files[0];
    const fd = new FormData();
    fd.append('file', file);
    const res = await fetch(uploadUrl, { method: 'POST', credentials: 'include', body: fd });
    const json = await res.json();
    if (json.ok && json.url) {
      if (kind === 'icon') document.getElementById('iconUrl').value = json.url;
      else document.getElementById('imageUrl').value = json.url;
      alert('Upload successful');
    } else {
      alert('Upload failed: ' + (json.error || 'unknown'));
    }
    fi.value = '';
  };
  fi.click();
}
</script>

{% endblock %}
